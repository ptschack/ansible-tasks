- include_tasks: apt.yml
  when: pm_apt.rc == 0

- name: install
  become: true
  package:
    name: syncthing
    state: present

- name: copy config files
  copy:
    src: "{{ item }}"
    dest: ~/.config/syncthing
    force: no
  with_items:
    - "{{ inventory_hostname }}/cert.pem"
    - "{{ inventory_hostname }}/config.xml"
    - "{{ inventory_hostname }}/https-cert.pem"
    - "{{ inventory_hostname }}/https-key.pem"
    - "{{ inventory_hostname }}/key.pem"
  ignore_errors: yes

- name: copy service file
  become: yes
  copy:
    src: syncthing@.service
    dest: /lib/systemd/system/syncthing@.service
    force: no
    mode: a+r

- name: configure & start service
  become: yes
  systemd:
    name: "syncthing@{{ ansible_user }}.service"
    daemon_reload: yes
    enabled: yes
    state: started